{"version":3,"file":"designer_ordering.min.js","sources":["../src/designer_ordering.js"],"sourcesContent":["define(['jquery', 'core_course/actions', 'core/ajax'], function($, action, ajax) {\r\n\r\n    var CSS = {\r\n        EDITINPROGRESS: 'editinprogress',\r\n        EDITINGMOVE: 'editing_move'\r\n    };\r\n\r\n    var SELECTOR = {\r\n        ACTIVITYLI: 'li.activity',\r\n        ACTIONAREA: '.actions',\r\n        SECTIONLI: 'li.section',\r\n    };\r\n    /**\r\n     * Implement the init.\r\n     */\r\n    function init() {\r\n\r\n        // Register a function to be executed after D&D of an activity.\r\n        Y.use('moodle-course-coursebase', function() {\r\n\r\n                M.course.coursebase.register_module({\r\n                    // Ignore camelcase eslint rule for the next line because it is an expected name of the callback.\r\n                    // eslint-disable-next-line camelcase\r\n                    set_visibility_resource_ui: function(args) {\r\n                        var mainelement = $(args.element.getDOMNode());\r\n                        var cmid = getModuleId(mainelement);\r\n                        if (cmid) {\r\n                            mainelement.css('opacity', 0);\r\n                            var sectionreturn = mainelement.find('.' + CSS.EDITINGMOVE).attr('data-sectionreturn');\r\n                            var sectionId = mainelement.closest(SELECTOR.SECTIONLI).attr('data-id');\r\n                            var spinner = addActivitySpinner(mainelement);\r\n                            var promises = ajax.call([{\r\n                                methodname: 'format_designer_get_module',\r\n                                args: {id: cmid, sectionid: sectionId, sectionreturn: sectionreturn}\r\n                            }], true);\r\n                            $.when.apply($, promises)\r\n                                .done(function(data) {\r\n                                removeSpinner(mainelement, spinner, 400);\r\n                                    replaceActivityHtmlWith(data);\r\n                                }).fail(function() {\r\n                                    removeSpinner(mainelement, spinner);\r\n                                });\r\n                        }\r\n                    }\r\n\r\n            });\r\n\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Replaces the course module with the new html (used to update module after it was edited or its visibility was changed).\r\n     *\r\n     * @param {String} activityHTML\r\n     */\r\n    function replaceActivityHtmlWith(activityHTML) {\r\n        setTimeout(function() {\r\n            $('<div>' + activityHTML + '</div>').find(SELECTOR.ACTIVITYLI).each(function() {\r\n                // Extract id from the new activity html.\r\n                var id = $(this).attr('id');\r\n                // Find the existing element with the same id and replace its contents with new html.\r\n                $(SELECTOR.ACTIVITYLI + '#' + id).replaceWith(activityHTML);\r\n                // Initialise action menu.\r\n                initActionMenu(id);\r\n                $(SELECTOR.ACTIVITYLI + '#' + id).css('opacity', 1);\r\n            });\r\n        }, 1000);\r\n    }\r\n\r\n    /**\r\n     * Wrapper for Y.Moodle.core_course.util.cm.getId\r\n     *\r\n     * @param {JQuery} element\r\n     * @returns {Integer}\r\n     */\r\n    function getModuleId(element) {\r\n        var id;\r\n        Y.use('moodle-course-util', function(Y) {\r\n            id = Y.Moodle.core_course.util.cm.getId(Y.Node(element.get(0)));\r\n        });\r\n        return id;\r\n    }\r\n\r\n    /**\r\n     * Removes the spinner element\r\n     *\r\n     * @param {JQuery} element\r\n     * @param {Node} spinner\r\n     * @param {Number} delay\r\n     */\r\n    function removeSpinner(element, spinner, delay) {\r\n        window.setTimeout(function() {\r\n            element.removeClass(CSS.EDITINPROGRESS);\r\n            if (spinner) {\r\n                spinner.hide();\r\n            }\r\n        }, delay);\r\n    }\r\n\r\n    /**\r\n     * Initialise action menu for the element (section or module)\r\n     *\r\n     * @param {String} elementid CSS id attribute of the element\r\n     */\r\n    function initActionMenu(elementid) {\r\n        // Initialise action menu in the new activity.\r\n        Y.use('moodle-course-coursebase', function() {\r\n            M.course.coursebase.invoke_function('setup_for_resource', '#' + elementid);\r\n        });\r\n        if (M.core.actionmenu && M.core.actionmenu.newDOMNode) {\r\n            M.core.actionmenu.newDOMNode(Y.one('#' + elementid));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Wrapper for M.util.add_spinner for an activity\r\n     *\r\n     * @param {JQuery} activity\r\n     * @returns {Node}\r\n     */\r\n    function addActivitySpinner(activity) {\r\n        activity.addClass(CSS.EDITINPROGRESS);\r\n        var actionarea = activity.find(SELECTOR.ACTIONAREA).get(0);\r\n        if (actionarea) {\r\n            var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\r\n            spinner.show();\r\n            return spinner;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"names":["define","$","action","ajax","CSS","EDITINPROGRESS","EDITINGMOVE","SELECTOR","ACTIVITYLI","ACTIONAREA","SECTIONLI","removeSpinner","element","spinner","delay","window","setTimeout","removeClass","hide","init","Y","use","M","course","coursebase","register_module","set_visibility_resource_ui","args","mainelement","id","getDOMNode","cmid","Moodle","core_course","util","cm","getId","Node","get","css","sectionreturn","find","attr","sectionId","closest","addActivitySpinner","activity","addClass","actionarea","add_spinner","show","promises","call","methodname","sectionid","when","apply","done","data","replaceActivityHtmlWith","activityHTML","each","elementid","this","replaceWith","invoke_function","core","actionmenu","newDOMNode","one","fail"],"mappings":"AAAAA,OAAO,oCAAA,CAAC,SAAU,sBAAuB,cAAc,SAASC,EAAGC,OAAQC,MAEvE,IAAIC,IAAM,CACNC,eAAgB,iBAChBC,YAAa,gBAGbC,SAAW,CACXC,WAAY,cACZC,WAAY,WACZC,UAAW,cAgFf,SAASC,cAAcC,QAASC,QAASC,OACrCC,OAAOC,YAAW,WACdJ,QAAQK,YAAYb,IAAIC,gBACpBQ,SACAA,QAAQK,MAHhB,GAKGJ,MACN,CAkCM,MAAA,CACHK,KArHJ,WAGIC,EAAEC,IAAI,4BAA4B,WAE1BC,EAAEC,OAAOC,WAAWC,gBAAgB,CAGhCC,2BAA4B,SAASC,MAC7BC,IAmDHhB,QACbiB,GApDgBD,YAAc3B,EAAE0B,KAAKf,QAAQkB,cAC7BC,MAkDHnB,QAlDsBgB,YAoDvCR,EAAEC,IAAI,sBAAsB,SAASD,GACjCS,GAAKT,EAAEY,OAAOC,YAAYC,KAAKC,GAAGC,MAAMhB,EAAEiB,KAAKzB,QAAQ0B,IAAI,IAC9D,IACMT,IAtDS,GAAIE,KAAM,CACNH,YAAYW,IAAI,UAAW,GAC3B,IAAIC,cAAgBZ,YAAYa,KAAK,IAAMrC,IAAIE,aAAaoC,KAAK,sBAC7DC,UAAYf,YAAYgB,QAAQrC,SAASG,WAAWgC,KAAK,WACzD7B,QA0FnBgC,SAAmBC,UACxBA,SAASC,SAAS3C,IAAIC,gBACtB,IAAI2C,WAAaF,SAASL,KAAKlC,SAASE,YAAY6B,IAAI,GACxD,GAAIU,WAAY,CACZ,IAAInC,QAAUS,EAAEY,KAAKe,YAAY7B,EAAGA,EAAEiB,KAAKW,aAE3C,OADAnC,QAAQqC,OACDrC,OACV,CACD,OAAO,IACV,CAnGqCgC,CAAmBjB,aAC7BuB,SAAWhD,KAAKiD,KAAK,CAAC,CACtBC,WAAY,6BACZ1B,KAAM,CAACE,GAAIE,KAAMuB,UAAWX,UAAWH,cAAeA,kBACtD,GACJvC,EAAEsD,KAAKC,MAAMvD,EAAGkD,UACXM,MAAK,SAASC,MAmBlCC,IAAwBC,aAlBLjD,cAAciB,YAAaf,QAAS,KAkB/B+C,aAjBuBF,KAkBpD1C,YAAW,WACPf,EAAE,QAAU2D,aAAe,UAAUnB,KAAKlC,SAASC,YAAYqD,MAAK,WAE5DhC,IA6CQiC,UA7CRjC,GAAK5B,EAAE8D,MAAMrB,KAAK,MAEtBzC,EAAEM,SAASC,WAAa,IAAMqB,IAAImC,YAAYJ,cA2ClCE,UAzCGjC,GA2CvBT,EAAEC,IAAI,4BAA4B,WAC9BC,EAAEC,OAAOC,WAAWyC,gBAAgB,qBAAsB,IAAMH,UACnE,IACGxC,EAAE4C,KAAKC,YAAc7C,EAAE4C,KAAKC,WAAWC,YACvC9C,EAAE4C,KAAKC,WAAWC,WAAWhD,EAAEiD,IAAI,IAAMP,YA9CrC7D,EAAEM,SAASC,WAAa,IAAMqB,IAAIU,IAAI,UAAW,EACpD,GATK,GAUP,IA3BsB,IAAE+B,MAAK,WACJ3D,cAAciB,YAAaf,QAC9B,GACR,CACJ,GAIZ,GACJ,EAsFJ"}