{"version":3,"file":"designer_section.min.js","sources":["../src/designer_section.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Implemented designer format js.\n *\n * @module     format_designer/designer_section\n * @copyright  2021 bdecent gmbh <https://bdecent.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n define(['jquery', 'core/fragment', 'core/templates', 'core/loadingicon', 'core/ajax', 'core_course/actions'],\n function($, Fragment, Templates, Loadingicon, Ajax, Actions) {\n\n    var SELECTOR = {\n        ACTIVITYLI: 'li.activity',\n        SECTIONLI: 'li.section',\n        ACTIVITYACTION: 'a.cm-edit-action',\n        SECTIONACTIONMENU: '.section_action_menu.designer-menu',\n    };\n\n    Y.use('moodle-course-coursebase', function() {\n        var courseformatselector = M.course.format.get_section_selector();\n        if (courseformatselector) {\n            SELECTOR.SECTIONLI = courseformatselector;\n        }\n    });\n\n\n    /**\n     * Control designer format action\n     * @param {int} courseId\n     * @param {int} contextId\n     * @param {array} popupActivities\n     */\n    let DesignerSection = function(courseId, contextId, popupActivities) {\n        var self = this;\n        self.courseId = courseId;\n        self.contextId = contextId;\n        self.popupActivities = popupActivities;\n\n        $('body').delegate(self.SectionController, 'click', self.sectionLayoutaction.bind(this));\n        $(\"body\").delegate(self.RestrictInfo, \"click\", self.moduleHandler.bind(this));\n        $(\"body\").delegate(self.sectionRestricted, \"click\", this.sectionRestrictHandler.bind(this));\n        $('body').delegate(self.fullDescription, \"click\", self.fullmodcontentHandler.bind(this));\n        $('body').delegate(self.trimDescription, \"click\", self.trimmodcontentHandler.bind(this));\n        $('body').delegate(self.goToURL, \"click\", self.redirectToModule.bind(this));\n        window.onhashchange = function() {\n            self.expandSection();\n        };\n        this.expandSection();\n\n        if ($('.course-type-flow').length > 0) {\n            $('.collapse').on('show.bs.collapse', function() {\n                $(this).parents('li.section').addClass('stack-header-collapsing');\n                var sectionid = $(this).parents('li.section').attr('id');\n                var section = document.getElementById(sectionid);\n                var distance = section.offsetTop - document.body.scrollTop;\n                setTimeout(() => window.scroll(0, distance), 50);\n            }).on('shown.bs.collapse', function() {\n                $(this).parents('li.section').removeClass('stack-header-collapsing');\n            });\n        }\n\n    };\n\n    /**\n     * Selector section controller.\n     */\n    DesignerSection.prototype.goToURL = '.designer [data-action=\"go-to-url\"]';\n\n    DesignerSection.prototype.SectionController = \".designer #section-designer-action .dropdown-menu a\";\n\n    DesignerSection.prototype.RestrictInfo = \".designer .designer-section-content .call-action-block\";\n\n    DesignerSection.prototype.moduleBlock = \".designer .designer-section-content li.activity\";\n\n    DesignerSection.prototype.loadingElement = \".icon-loader-block\";\n\n    DesignerSection.prototype.sectionRestricted = \".designer .availability-section-block .section-restricted-action\";\n\n    DesignerSection.prototype.fullDescription = \".designer-section-content li .fullcontent-summary .mod-description-action\";\n\n    DesignerSection.prototype.trimDescription = \".designer-section-content li .trim-summary .mod-description-action\";\n\n    DesignerSection.prototype.modules = null;\n\n    DesignerSection.prototype.redirectToModule = function(event) {\n        let nodeName = event.target.nodeName;\n        let preventionNodes = ['a', 'button', 'form'];\n        let iscircle = event.target.closest('li.activity').classList.contains('circle-layout');\n        let isDescription = event.target.classList.contains('mod-description-action');\n        let isPadlock = event.target.classList.contains('fa-lock');\n        let ispopupModule = event.target.closest('li.activity').classList.contains('popmodule');\n        if ((nodeName in preventionNodes)\n            || document.body.classList.contains('editing') || iscircle || isDescription || isPadlock || ispopupModule) {\n            if (ispopupModule && !document.body.classList.contains('editing')) {\n                var li = event.target.closest('li.activity');\n                li.querySelector('a[href]').click();\n                // event.target.closest('a').click();\n            }\n            return null;\n        }\n        var card = event.target.closest(\"[data-action=go-to-url]\");\n        let modurl = card.getAttribute('data-url');\n        window.location.href = modurl;\n        return true;\n    };\n\n    DesignerSection.prototype.expandSection = () => {\n        var sectionID = window.location.hash;\n        if (sectionID) {\n            var id = sectionID.substring(1);\n            var section = document.getElementById(id);\n            if (section) {\n                var title = section.querySelector('.section-header-content');\n                if (title) {\n                    title.classList.remove('collapsed');\n                    title.setAttribute('aria-expanded', true);\n                }\n                var content = section.querySelector('.content');\n                if (content) {\n                    content.classList.add('show');\n                }\n                if (document.getElementById('section-course-accordion') !== null) {\n                    document.getElementById('section-head-0').classList.add('collapsed');\n                    document.getElementById('section-content-0').classList.remove('show');\n                }\n                section.scrollIntoView();\n            }\n        }\n    };\n\n    DesignerSection.prototype.fullmodcontentHandler = function(event) {\n        var THIS = $(event.currentTarget);\n        let fullContent = $(THIS).closest('li.activity').find('.fullcontent-summary');\n        let trimcontent = $(THIS).closest('li.activity').find('.trim-summary');\n        if (trimcontent.hasClass('summary-hide')) {\n            trimcontent.removeClass('summary-hide');\n            fullContent.addClass('summary-hide');\n        }\n    };\n\n    DesignerSection.prototype.trimmodcontentHandler = function(event) {\n        var THIS = $(event.currentTarget);\n        let fullContent = $(THIS).closest('li.activity').find('.fullcontent-summary');\n        let trimcontent = $(THIS).closest('li.activity').find('.trim-summary');\n        if (fullContent.hasClass('summary-hide')) {\n            fullContent.removeClass('summary-hide');\n            trimcontent.addClass('summary-hide');\n        }\n    };\n\n    DesignerSection.prototype.sectionRestrictHandler = function(event) {\n        var sectionRestrictInfo = $(event.currentTarget).prev();\n        if (sectionRestrictInfo) {\n            if (!sectionRestrictInfo.hasClass('show')) {\n                sectionRestrictInfo.addClass('show');\n            } else {\n                sectionRestrictInfo.removeClass('show');\n            }\n        }\n    };\n\n    DesignerSection.prototype.moduleHandler = function(event) {\n        event.preventDefault();\n        var restrictBlock = $(event.currentTarget).parents('.restrict-block');\n        if (restrictBlock.length) {\n            if (!restrictBlock.hasClass('show')) {\n                restrictBlock.addClass('show');\n            } else {\n                restrictBlock.removeClass('show');\n            }\n        }\n    };\n\n    /**\n     * Implementaion swith the section layout.\n     * @param {object} event\n     */\n    DesignerSection.prototype.sectionLayoutaction = function(event) {\n        var self = this;\n        let sectionId = event.target.closest('li.section').getAttribute('id');\n        var iconBlock = \"#\" + sectionId + \" \" + self.loadingElement;\n        var layout = $(event.currentTarget).data('value');\n        var layouttext = $(event.currentTarget).text();\n        $(event.target).parents(\".dropdown\").find(\".btn\").html(layouttext);\n        $(event.target).parents(\".dropdown\").find(\".btn\").val(layout);\n        $(event.target).parent().find(\"a.dropdown-item\").each(function() {\n            $(this).removeClass('active');\n        });\n        $(event.target).addClass('active');\n        let dataid = event.target.closest('li.section').getAttribute('data-id');\n        var args = {\n            courseid: self.courseId,\n            sectionid: dataid,\n            options: [{name: $(event.currentTarget).data('option'), value: layout}]\n        };\n        var promises = Ajax.call([{\n                methodname: 'format_designer_set_section_options',\n                args: args\n            }], true);\n            $.when.apply($, promises)\n            .done(function() {\n                const sectionpromise = Actions.refreshSection('#' + sectionId, dataid, 0);\n                sectionpromise.then(() => {\n                   return '';\n                }).catch();\n            });\n        Loadingicon.addIconToContainerRemoveOnCompletion(iconBlock, promises);\n    };\n\n    return {\n        init: function(courseId, contextId, popupActivities) {\n            return new DesignerSection(courseId, contextId, popupActivities);\n        }\n    };\n});"],"names":["define","$","Fragment","Templates","Loadingicon","Ajax","Actions","SELECTOR","ACTIVITYLI","SECTIONLI","ACTIVITYACTION","SECTIONACTIONMENU","Y","use","courseformatselector","M","course","format","get_section_selector","DesignerSection","courseId","contextId","popupActivities","self","this","delegate","SectionController","sectionLayoutaction","bind","RestrictInfo","moduleHandler","sectionRestricted","sectionRestrictHandler","fullDescription","fullmodcontentHandler","trimDescription","trimmodcontentHandler","goToURL","redirectToModule","window","onhashchange","expandSection","length","on","parents","addClass","sectionid","attr","distance","document","getElementById","offsetTop","body","scrollTop","setTimeout","scroll","removeClass","prototype","moduleBlock","loadingElement","modules","event","nodeName","target","iscircle","closest","classList","contains","isDescription","isPadlock","ispopupModule","querySelector","click","modurl","getAttribute","location","href","sectionID","hash","id","substring","section","title","remove","setAttribute","content","add","scrollIntoView","THIS","currentTarget","fullContent","find","trimcontent","hasClass","sectionRestrictInfo","prev","preventDefault","restrictBlock","sectionId","iconBlock","layout","data","layouttext","text","html","val","parent","each","dataid","args","courseid","options","name","value","promises","call","methodname","when","apply","done","refreshSection","then","catch","addIconToContainerRemoveOnCompletion","init"],"mappings":"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"}